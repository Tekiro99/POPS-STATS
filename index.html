<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PopsCoin — калькулятор заточки</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --muted:#8aa0b2; --text:#e7f0f7;
    --acc:#5ad2ff; --err:#ff6b6b; --ok:#80ffb0;
    --br:14px; --pad:14px; --gap:12px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  *:focus{outline:none}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1100px 520px at 70% -10%,#0f2233 0%,transparent 60%), var(--bg);
    color:var(--text); line-height:1.35;
  }
  .wrap{max-width:960px;margin:20px auto;padding:14px}
  .card{background:linear-gradient(180deg,#0f1620 0%, var(--panel) 100%); border:1px solid #1c2633; border-radius:var(--br); box-shadow:0 10px 26px rgba(0,0,0,.35)}
  header{padding:16px var(--pad); border-bottom:1px solid #1c2633; display:flex; justify-content:center; align-items:center}
  h1{margin:0;font-size:18px;letter-spacing:.2px;text-align:center}

  .content{padding:14px var(--pad) 12px}
  .grid{display:grid; grid-template-columns:1fr; gap:var(--gap); justify-items:center}

  /* Segmented (tabs) */
  .seg{
    display:inline-grid; grid-auto-flow:column; gap:8px; background:#0f1620; padding:6px; border-radius:999px; border:1px solid #1c2633
  }
  .seg input{display:none}
  .seg label{
    padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:var(--muted);
    transition:background .12s ease, transform .06s ease; user-select:none; white-space:nowrap
  }
  .seg input:checked + label{ background:#132030; color:var(--text); transform:translateY(-1px) }
  .seg label .tag{
    margin-left:6px; font-size:10px; font-weight:800; color:#b9d8ff;
    background:#122235; border:1px solid #20364c; border-radius:8px; padding:2px 6px; position:relative; top:-1px;
  }

  /* Fields */
  .form-area{width:100%; max-width:740px}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); align-items:end; justify-items:center}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap); align-items:end; justify-items:center}
  .row4{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:var(--gap); align-items:end; justify-items:center}
  .row1{display:grid; grid-template-columns:1fr; gap:var(--gap); align-items:end; justify-items:center}

  .field{display:flex; flex-direction:column; gap:6px; align-items:center; width:100%; max-width:260px}
  .field label{
    font-size:13px;color:var(--muted); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis
  }
  .field input, .field select{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #233142; background:#0b1118; color:var(--text);
    font-size:16px; text-align:center; -webkit-appearance:none; appearance:none;
  }
  .hint{font-size:12px; color:#9fb5c7; text-align:center}

  /* Actions */
  .actions{display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px}
  button{
    appearance:none; -webkit-appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer;
    background:linear-gradient(135deg,var(--acc) 0%, #7be6ff 100%); color:#033346;
    box-shadow:0 8px 18px rgba(90,210,255,.30); transition:transform .08s ease, filter .2s ease
  }
  button:active{transform:translateY(1px)}
  .ghost{background:#182231; color:#c6d3de; box-shadow:none}
  .err{color:var(--err); font-size:13px; margin-top:8px; display:none; text-align:center}

  /* Results containers behave like different pages */
  .page{display:none}
  .page.active{display:block}

  /* Table (Инструменты и оружие) */
  .table{border:1px solid #1c2633; border-radius:12px; background:#0c1119; width:100%}
  table{width:100%; table-layout:fixed; border-collapse:separate; border-spacing:0}
  col.lvl{width:18%} col.min{width:27%} col.max{width:27%} col.avg{width:28%}
  th, td{
    padding:10px 8px; border-bottom:1px solid #172231; text-align:right; font-variant-numeric: tabular-nums;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis
  }
  th:first-child, td:first-child{text-align:center}
  thead th{font-size:12px; color:#a9bdcd; background:#101827; text-transform:none; letter-spacing:0}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}

  /* Summary cards for Spells */
  .summary{
    display:grid; gap:12px; width:100%; max-width:820px;
    grid-template-columns: repeat(2, minmax(0,1fr));
  }
  .card-mini{
    background:#0c1119; border:1px solid #1c2633; border-radius:12px; padding:12px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .card-mini h3{margin:0; font-size:13px; color:#9fb5c7; font-weight:600}
  .val{font-weight:800; font-variant-numeric: tabular-nums; font-size:18px}
  .ok{color:var(--ok)}

  .runes{display:grid; gap:10px; grid-template-columns: repeat(3, minmax(0,1fr));}
  .runes .field{max-width:none}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; color:#a9bdcd}

  /* Mobile */
  @media (max-width: 820px){
    .summary{grid-template-columns: 1fr;}
    .runes{grid-template-columns: 1fr;}
  }
  @media (max-width: 560px){
    .wrap{padding:10px}
    header{padding:12px}
    h1{font-size:16px}
    .content{padding:12px}
    .row2,.row3,.row4{gap:10px}
    .field input{padding:10px 10px; font-size:16px}
    th, td{padding:8px 6px; font-size:13px}
    col.lvl{width:16%} col.min{width:28%} col.max{width:28%} col.avg{width:28%}
    .seg label{padding:8px 10px; font-size:13px}
    .form-area{max-width:560px}
  }
  @media (max-width: 380px){
    th, td{font-size:12px; padding:6px 3px}
    h1{font-size:15px}
    .seg label{font-size:12px}
    col.lvl{width:16%} col.min{width:28%} col.max{width:28%} col.avg{width:28%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header><h1>PopsCoin — калькулятор заточки</h1></header>

      <div class="content">
        <div class="grid">
          <div class="field" style="max-width:none">
            <label>Раздел</label>
            <div class="seg" role="tablist" aria-label="Раздел калькулятора">
              <input type="radio" name="tab" id="tab_gear" value="gear" checked><label for="tab_gear">Инструменты и оружие</label>
              <input type="radio" name="tab" id="tab_spell" value="spell"><label for="tab_spell">Способности</label>
            </div>
          </div>
        </div>

        <!-- PAGE: GEAR (инструменты и оружие) -->
        <section class="page active" id="page_gear" aria-labelledby="tab_gear">
          <div class="grid">
            <div id="gear_inputs" class="form-area">
              <div class="row2">
                <div class="field">
                  <label>Мин</label>
                  <input inputmode="numeric" pattern="\\d*" id="min" placeholder="10">
                </div>
                <div class="field">
                  <label>Макс</label>
                  <input inputmode="numeric" pattern="\\d*" id="max" placeholder="20">
                </div>
              </div>
              <div class="actions">
                <button id="calcGear">Калькуляция</button>
                <button class="ghost" id="resetGear" type="button">Сброс</button>
              </div>
              <div id="msgGear" class="err"></div>
            </div>

            <div id="gear_results" style="width:100%">
              <div class="table" id="tableHolder" hidden></div>
            </div>
          </div>
        </section>

        <!-- PAGE: SPELLS (способности) -->
        <section class="page" id="page_spell" aria-labelledby="tab_spell">
          <div class="grid">
            <div id="spell_inputs" class="form-area">
              <div class="row4">
                <div class="field"><label>Мин урон</label><input inputmode="decimal" id="s_min" placeholder="50"></div>
                <div class="field"><label>Макс урон</label><input inputmode="decimal" id="s_max" placeholder="100"></div>
                <div class="field"><label>Затраты маны</label><input inputmode="decimal" id="s_mana" placeholder="10"></div>
                <div class="field"><label>Сила заклинания, %</label><input inputmode="decimal" id="s_power" placeholder="10"></div>
              </div>
              <div class="row1" style="margin-top:10px">
                <div class="runes">
                  <!-- rune selects -->
                  <div class="field">
                    <label>Слот 1</label>
                    <div class="row2" style="grid-template-columns:1.2fr .8fr">
                      <select id="r1_type">
                        <option value="">Пусто</option>
                        <option value="ignar">Игнар (+урон)</option>
                        <option value="dragor">Драгор (вамп.)</option>
                        <option value="vinar">Винар (лечение)</option>
                        <option value="sanar">Санар (-мана)</option>
                      </select>
                      <select id="r1_tier">
                        <option value="0">Тир</option>
                        <option value="1">I</option>
                        <option value="2">II</option>
                        <option value="3">III</option>
                      </select>
                    </div>
                  </div>
                  <div class="field">
                    <label>Слот 2</label>
                    <div class="row2" style="grid-template-columns:1.2fr .8fr">
                      <select id="r2_type">
                        <option value="">Пусто</option>
                        <option value="ignar">Игнар (+урон)</option>
                        <option value="dragor">Драгор (вамп.)</option>
                        <option value="vinar">Винар (лечение)</option>
                        <option value="sanar">Санар (-мана)</option>
                      </select>
                      <select id="r2_tier">
                        <option value="0">Тир</option>
                        <option value="1">I</option>
                        <option value="2">II</option>
                        <option value="3">III</option>
                      </select>
                    </div>
                  </div>
                  <div class="field">
                    <label>Слот 3</label>
                    <div class="row2" style="grid-template-columns:1.2fr .8fr">
                      <select id="r3_type">
                        <option value="">Пусто</option>
                        <option value="ignar">Игнар (+урон)</option>
                        <option value="dragor">Драгор (вамп.)</option>
                        <option value="vinar">Винар (лечение)</option>
                        <option value="sanar">Санар (-мана)</option>
                      </select>
                      <select id="r3_tier">
                        <option value="0">Тир</option>
                        <option value="1">I</option>
                        <option value="2">II</option>
                        <option value="3">III</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="hint">Тиры: I/II/III дают 10% / 20% / 30% к соответствующему параметру.</div>
              </div>
              <div class="actions">
                <button id="calcSpell">Калькуляция</button>
                <button class="ghost" id="resetSpell" type="button">Сброс</button>
              </div>
              <div id="msgSpell" class="err"></div>
            </div>

            <div id="spell_results" style="width:100%">
              <div id="spellSummary" class="summary" hidden></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel, root=document) => root.querySelector(sel);
  const show = el => el.hidden = false;
  const hide = el => el.hidden = true;

  // Tabs -> switch pages
  const pages = {
    gear: $('#page_gear'),
    spell: $('#page_spell')
  };
  function switchPage(name){
    Object.keys(pages).forEach(k => pages[k].classList.remove('active'));
    pages[name].classList.add('active');
    // Scroll into view for mobile ergonomics
    pages[name].scrollIntoView({behavior:'smooth', block:'start'});
  }
  document.querySelectorAll('input[name="tab"]').forEach(r => {
    r.addEventListener('change', e => switchPage(e.target.value));
  });

  /* ======================
     GEAR (Инструменты/оружие)
     ====================== */
  const tableHolder = $('#tableHolder');
  const calcGear = $('#calcGear');
  const resetGear = $('#resetGear');
  const msgGear = $('#msgGear');
  const minEl = $('#min'), maxEl = $('#max');

  const step = v => Math.round(v * 1.2); // 20% per level as before

  function renderTable(headers, rows){
    const colgroup = `
      <colgroup>
        <col class="lvl"><col class="min"><col class="max"><col class="avg">
      </colgroup>`;
    const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>`<tr>
      <td class="lvl">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
    </tr>`).join('')}</tbody>`;
    tableHolder.innerHTML = `<table>${colgroup}${thead}${tbody}</table>`;
  }

  function valNum(input){
    const raw = (input.value || '').toString().replace(',', '.').replace(/[^0-9.\-]/g, '');
    if(raw === '' || raw === '.' || raw === '-' ) return NaN;
    return parseFloat(raw);
  }

  calcGear.addEventListener('click', () => {
    msgGear.style.display = 'none';
    const baseMin = valNum(minEl), baseMax = valNum(maxEl);
    if(!Number.isFinite(baseMin) || !Number.isFinite(baseMax) || baseMin<=0 || baseMax<=0 || baseMin>baseMax){
      msgGear.textContent = 'Проверьте базовые значения: положительные числа и мин ≤ макс.';
      msgGear.style.display = 'block';
      hide(tableHolder);
      return;
    }
    let curMin = Math.round(baseMin), curMax = Math.round(baseMax);
    const rows = [];
    for(let lvl=1; lvl<=20; lvl++){
      curMin = step(curMin);
      curMax = step(curMax);
      const avg = Math.round((curMin + curMax)/2);
      rows.push([`+${lvl}`, curMin, curMax, avg]);
    }
    renderTable(['ур','мин','макс','ср'], rows);
    show(tableHolder);
  });

  resetGear.addEventListener('click', () => {
    minEl.value = ''; maxEl.value = '';
    hide(tableHolder);
    msgGear.style.display = 'none';
  });

  /* ======================
     SPELLS (Способности)
     ====================== */
  const spellSummary = $('#spellSummary');
  const calcSpell = $('#calcSpell');
  const resetSpell = $('#resetSpell');
  const msgSpell = $('#msgSpell');

  function pct(n){ return Math.round(n*100); }

  function get(valSel){ return $(valSel); }

  function runeSumByType(){
    let ignar = 0, dragor = 0, vinar = 0, sanar = 0;
    ['r1','r2','r3'].forEach(id => {
      const t = get('#'+id+'_type').value;
      const tier = parseInt(get('#'+id+'_tier').value || '0', 10);
      const add = (tier>=1 && tier<=3) ? tier*0.10 : 0; // 10/20/30%
      if(t === 'ignar') ignar += add;
      if(t === 'dragor') dragor += add;
      if(t === 'vinar') vinar += add;
      if(t === 'sanar') sanar += add;
    });
    return {ignar, dragor, vinar, sanar};
  }

  calcSpell.addEventListener('click', () => {
    msgSpell.style.display = 'none';
    const smin = valNum(get('#s_min'));
    const smax = valNum(get('#s_max'));
    const mana = valNum(get('#s_mana'));
    let sp = valNum(get('#s_power')); // spell power in %
    if(!Number.isFinite(smin) || !Number.isFinite(smax) || !Number.isFinite(mana) || smin<=0 || smax<=0 || smin>smax || mana<0){
      msgSpell.textContent = 'Проверьте значения: мин/макс > 0 и мин ≤ макс, мана ≥ 0.';
      msgSpell.style.display = 'block';
      hide(spellSummary);
      return;
    }
    if(!Number.isFinite(sp)) sp = 0;
    sp = Math.max(-100, sp) / 100; // convert to fraction

    const {ignar, dragor, vinar, sanar} = runeSumByType();

    // NEW: runes apply to base first; then Spell Power applies on top.
    // 1) base with runes
    const baseMinWithRunes = smin * (1 + ignar);
    const baseMaxWithRunes = smax * (1 + ignar);
    // 2) apply spell power after runes
    const rMin = Math.round(baseMinWithRunes * (1 + sp));
    const rMax = Math.round(baseMaxWithRunes * (1 + sp));
    const rAvg = Math.round((rMin + rMax)/2);
    // Mana reduction by Sanar
    const rMana = Math.max(0, Math.round(mana * Math.max(0, 1 - sanar)));

    const roman = (n)=> n===1?'I':(n===2?'II':(n===3?'III':''));

    spellSummary.innerHTML = `
      <div class="card-mini"><h3>Итоговый урон</h3><div class="val">${rMin}&nbsp;–&nbsp;${rMax}</div></div>
      <div class="card-mini"><h3>Средний урон</h3><div class="val">${rAvg}</div></div>
      <div class="card-mini"><h3>Затраты маны</h3><div class="val ${rMana<mana?'ok':''}">${rMana}</div></div>
      <div class="card-mini"><h3>Сила заклинания</h3><div class="val">${pct(sp)}%</div></div>
      <div class="card-mini"><h3>Игнар (урон)</h3><div class="val">${pct(ignar)}%</div></div>
      <div class="card-mini"><h3>Санар (мана)</h3><div class="val">${pct(sanar)}%</div></div>
      <div class="card-mini"><h3>Драгор (вамп.)</h3><div class="val">${pct(dragor)}%</div></div>
      <div class="card-mini"><h3>Винар (лечение)</h3><div class="val">${pct(vinar)}%</div></div>
      <div class="card-mini" style="grid-column:1/-1">
        <h3>Слоты рун</h3>
        <div class="mono">
          1) ${(get('#r1_type').value || '—')} ${roman(parseInt(get('#r1_tier').value||'0',10))}<br>
          2) ${(get('#r2_type').value || '—')} ${roman(parseInt(get('#r2_tier').value||'0',10))}<br>
          3) ${(get('#r3_type').value || '—')} ${roman(parseInt(get('#r3_tier').value||'0',10))}
        </div>
      </div>
    `;
    show(spellSummary);
  });

  resetSpell.addEventListener('click', () => {
    ['#s_min','#s_max','#s_mana','#s_power'].forEach(sel => get(sel).value='');
    ['r1','r2','r3'].forEach(id => {
      get('#'+id+'_type').value='';
      get('#'+id+'_tier').value='0';
    });
    hide(spellSummary);
    msgSpell.style.display = 'none';
  });
})();
</script>
</body>
</html>
