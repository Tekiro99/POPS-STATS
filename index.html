<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PopsCoin — калькулятор заточки</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --muted:#8aa0b2; --text:#e7f0f7;
    --acc:#5ad2ff; --err:#ff6b6b;
    --br:14px; --pad:14px; --gap:12px;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  *:focus{outline:none}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1100px 520px at 70% -10%,#0f2233 0%,transparent 60%), var(--bg);
    color:var(--text); line-height:1.35;
  }
  .wrap{max-width:780px;margin:20px auto;padding:14px}
  .card{background:linear-gradient(180deg,#0f1620 0%, var(--panel) 100%); border:1px solid #1c2633; border-radius:var(--br); box-shadow:0 10px 26px rgba(0,0,0,.35)}
  header{padding:16px var(--pad); border-bottom:1px solid #1c2633; display:flex; justify-content:center; align-items:center}
  h1{margin:0;font-size:18px;letter-spacing:.2px;text-align:center}

  .content{padding:14px var(--pad) 12px}
  .grid{display:grid; grid-template-columns:1fr; gap:var(--gap); justify-items:center}

  /* Segmented */
  .seg{
    display:inline-grid; grid-auto-flow:column; gap:8px; background:#0f1620; padding:6px; border-radius:999px; border:1px solid #1c2633
  }
  .seg input{display:none}
  .seg label{
    padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:var(--muted);
    transition:background .12s ease, transform .06s ease; user-select:none; white-space:nowrap
  }
  .seg input:checked + label{ background:#132030; color:var(--text); transform:translateY(-1px) }
  .seg label .tag{
    margin-left:6px; font-size:10px; font-weight:800; color:#b9d8ff;
    background:#122235; border:1px solid #20364c; border-radius:8px; padding:2px 6px; position:relative; top:-1px;
  }

  /* Fields */
  .form-area{width:100%; max-width:560px}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); align-items:end; justify-items:center}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap); align-items:end; justify-items:center}

  .field{display:flex; flex-direction:column; gap:6px; align-items:center; width:100%; max-width:260px}
  .field label{
    font-size:13px;color:var(--muted); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis
  }
  .field input{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #233142; background:#0b1118; color:var(--text);
    font-size:16px; text-align:center; -webkit-appearance:none; appearance:none;
  }

  /* Actions */
  .actions{display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px}
  button{
    appearance:none; -webkit-appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer;
    background:linear-gradient(135deg,var(--acc) 0%, #7be6ff 100%); color:#033346;
    box-shadow:0 8px 18px rgba(90,210,255,.30); transition:transform .08s ease, filter .2s ease
  }
  button:active{transform:translateY(1px)}
  .ghost{background:#182231; color:#c6d3de; box-shadow:none}
  .err{color:var(--err); font-size:13px; margin-top:8px; display:none; text-align:center}

  /* Results — компактная таблица без горизонтального скролла */
  .results-wrap{overflow:hidden; max-height:0; transition:max-height .45s ease}
  .results{padding:8px var(--pad) 14px; display:flex; justify-content:center}
  .table{border:1px solid #1c2633; border-radius:12px; background:#0c1119; width:100%; max-width:680px}
  table{width:100%; table-layout:fixed; border-collapse:separate; border-spacing:0}
  /* Узкие короткие заголовки и колонки */
  col.lvl{width:18%}
  col.min{width:27%}
  col.max{width:27%}
  col.avg{width:28%}
  th, td{
    padding:8px 6px; border-bottom:1px solid #172231; text-align:right; font-variant-numeric: tabular-nums;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis
  }
  th:first-child, td:first-child{text-align:center}
  thead th{font-size:12px; color:#a9bdcd; background:#101827; text-transform:none; letter-spacing:0}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
  .lvl{font-weight:700}

  /* Мобильные улучшения */
  @media (max-width: 560px){
    .wrap{padding:10px}
    header{padding:12px}
    h1{font-size:16px}
    .content{padding:12px}
    .row2,.row3{gap:10px}
    .field input{padding:10px 10px; font-size:16px}
    th, td{padding:7px 4px; font-size:13px}
    col.lvl{width:16%} col.min{width:28%} col.max{width:28%} col.avg{width:28%}
    .seg label{padding:8px 10px; font-size:13px}
    .form-area{max-width:520px}
  }
  @media (max-width: 380px){
    th, td{font-size:12px; padding:6px 3px}
    h1{font-size:15px}
    .seg label{font-size:12px}
    col.lvl{width:16%} col.min{width:28%} col.max{width:28%} col.avg{width:28%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header><h1>PopsCoin — калькулятор заточки</h1></header>

      <div class="content">
        <div class="grid">
          <div class="field" style="max-width:none">
            <label>Тип</label>
            <div class="seg" role="tablist" aria-label="Тип предмета">
              <input type="radio" name="type" id="t1" value="uni" checked><label for="t1">Инструмент/Оружие</label>
              <input type="radio" name="type" id="t3" value="armor"><label for="t3">Броня <span class="tag">Тест</span></label>
            </div>
          </div>

          <div id="inputs" class="form-area"></div>
        </div>

        <div class="actions">
          <button id="calcBtn">Калькуляция</button>
          <button class="ghost" id="resetBtn" type="button">Сброс</button>
        </div>

        <div id="msg" class="err"></div>
      </div>

      <div class="results-wrap" id="resultsWrap">
        <div class="results">
          <div class="table" id="tableHolder" hidden></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const inputsHost = document.getElementById('inputs');
  const resultsWrap = document.getElementById('resultsWrap');
  const tableHolder = document.getElementById('tableHolder');
  const calcBtn = document.getElementById('calcBtn');
  const resetBtn = document.getElementById('resetBtn');
  const msg = document.getElementById('msg');

  const $ = (sel, root=document) => root.querySelector(sel);

  const views = {
    uni(){
      const frag = document.createElement('div');
      frag.className = 'row2';
      frag.innerHTML = `
        <div class="field">
          <label>Мин</label>
          <input inputmode="numeric" pattern="\\d*" id="min" placeholder="10">
        </div>
        <div class="field">
          <label>Макс</label>
          <input inputmode="numeric" pattern="\\d*" id="max" placeholder="20">
        </div>`;
      return frag;
    },
    armor(){
      const frag = document.createElement('div');
      frag.className = 'row3';
      frag.innerHTML = `
        <div class="field"><label>HP</label><input inputmode="numeric" pattern="\\d*" id="hp" placeholder="100"></div>
        <div class="field"><label>MP</label><input inputmode="numeric" pattern="\\d*" id="mp" placeholder="50"></div>
        <div class="field"><label>KB</label><input inputmode="numeric" pattern="\\d*" id="kb" placeholder="5"></div>`;
      return frag;
    }
  };

  function setView(kind){
    inputsHost.innerHTML = '';
    inputsHost.appendChild(views[kind]());
  }

  // init
  setView('uni');
  document.querySelectorAll('input[name="type"]').forEach(r => {
    r.addEventListener('change', e => setView(e.target.value));
  });

  function valInt(input){
    const v = (input.value || '').toString().replace(/[^\d]/g,'');
    if(v === '') return NaN;
    return parseInt(v, 10);
  }

  // Рост на 20% с округлением к ближайшему (как в игре)
  const step = v => Math.round(v * 1.2);

  function expand(){
    tableHolder.hidden = false;
    resultsWrap.style.maxHeight = resultsWrap.scrollHeight + 'px';
  }
  function collapse(){
    resultsWrap.style.maxHeight = '0px';
    tableHolder.hidden = true;
  }

  function renderCompact(headers, rows){
    const colgroup = `
      <colgroup>
        <col class="lvl"><col class="min"><col class="max"><col class="avg">
      </colgroup>`;
    const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>`<tr>
      <td class="lvl">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
    </tr>`).join('')}</tbody>`;
    tableHolder.innerHTML = `<table>${colgroup}${thead}${tbody}</table>`;
  }

  calcBtn.addEventListener('click', () => {
    msg.style.display = 'none';
    const kind = $('input[name="type"]:checked').value;

    if(kind === 'uni'){
      const minEl = $('#min', inputsHost), maxEl = $('#max', inputsHost);
      const baseMin = valInt(minEl), baseMax = valInt(maxEl);
      if(!Number.isFinite(baseMin) || !Number.isFinite(baseMax) || baseMin<=0 || baseMax<=0 || baseMin>baseMax){
        msg.textContent = 'Проверьте базовые значения: положительные целые, и мин ≤ макс.';
        msg.style.display = 'block'; collapse(); return;
      }
      let curMin = baseMin, curMax = baseMax;
      const rows = [];
      for(let lvl=1; lvl<=20; lvl++){
        curMin = step(curMin);
        curMax = step(curMax);
        const avg = Math.round((curMin + curMax)/2);
        rows.push([`+${lvl}`, curMin, curMax, avg]);
      }
      renderCompact(['ур','мин','макс','ср'], rows);
      expand();
    } else {
      const hpEl = $('#hp', inputsHost), mpEl = $('#mp', inputsHost), kbEl = $('#kb', inputsHost);
      const baseHP = valInt(hpEl), baseMP = valInt(mpEl), baseKB = valInt(kbEl);
      if(!Number.isFinite(baseHP) || !Number.isFinite(baseMP) || !Number.isFinite(baseKB) || baseHP<=0 || baseMP<0 || baseKB<0){
        msg.textContent = 'Проверьте значения брони: HP > 0, MP ≥ 0, KB ≥ 0 (целые).';
        msg.style.display = 'block'; collapse(); return;
      }
      let hp=baseHP, mp=baseMP, kb=baseKB;
      const rows = [];
      for(let lvl=1; lvl<=20; lvl++){
        hp = step(hp); mp = step(mp); kb = step(kb);
        rows.push([`+${lvl}`, hp, mp, kb]);
      }
      // Armor headers: короткие и не переносятся
      const colgroup = `<colgroup><col class="lvl"><col class="min"><col class="max"><col class="avg"></colgroup>`;
      const thead = `<thead><tr><th>ур</th><th>HP</th><th>MP</th><th>KB</th></tr></thead>`;
      const tbody = `<tbody>${rows.map(r=>`<tr><td class="lvl">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`).join('')}</tbody>`;
      tableHolder.innerHTML = `<table>${colgroup}${thead}${tbody}</table>`;
      expand();
    }
  });

  resetBtn.addEventListener('click', ()=>{
    const kind = $('input[name="type"]:checked').value;
    setView(kind);
    collapse();
    msg.style.display = 'none';
    resetBtn.animate([{transform:'scale(1)'},{transform:'scale(0.97)'},{transform:'scale(1)'}],{duration:140});
  });

  // Подгон высоты при изменении
  const ro = new ResizeObserver(()=>{ if(!tableHolder.hidden){ resultsWrap.style.maxHeight = resultsWrap.scrollHeight + 'px'; }});
  ro.observe(resultsWrap);
})();
</script>
</body>
</html>
