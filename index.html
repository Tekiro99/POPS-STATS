<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PopsCoin — калькулятор заточки</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --muted:#8aa0b2; --text:#e7f0f7;
    --acc:#5ad2ff; --acc2:#8fff7a; --err:#ff6b6b; --ring:rgba(90,210,255,.35);
    --br:14px; --pad:14px; --gap:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1200px 600px at 70% -10%,#0f2233 0%,transparent 60%), var(--bg);
    color:var(--text); line-height:1.35;
  }
  .wrap{max-width:980px;margin:24px auto;padding:18px}
  .card{background:linear-gradient(180deg,#0f1620 0%, var(--panel) 100%); border:1px solid #1d2733; border-radius:var(--br); box-shadow:0 10px 30px rgba(0,0,0,.35)}
  header{padding:22px var(--pad) 16px; border-bottom:1px solid #1d2733; display:flex; justify-content:space-between; align-items:center; gap:10px}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  .badge{font-size:12px;color:#0b1b24;background:linear-gradient(135deg,var(--acc),#7be6ff);padding:6px 10px;border-radius:999px;font-weight:700}
  .content{padding:18px}
  .grid{display:grid; grid-template-columns:1fr; gap:var(--gap)}
  @media (min-width:760px){ .grid{grid-template-columns:1.1fr 1fr}}
  .seg{
    display:inline-grid; grid-auto-flow:column; gap:8px; background:#0f1620; padding:6px; border-radius:999px; border:1px solid #1c2633
  }
  .seg input{display:none}
  .seg label{
    padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:600; color:var(--muted);
    transition:.15s transform ease, .15s background ease, .15s color ease;
    user-select:none; white-space:nowrap
  }
  .seg input:checked + label{
    background:linear-gradient(135deg,#123347 0%, #0f2433 100%);
    box-shadow:0 0 0 3px var(--ring) inset, 0 2px 12px rgba(90,210,255,.25);
    color:var(--text); transform:translateY(-1px)
  }
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:13px;color:var(--muted)}
  .field input{
    width:100%; padding:12px 12px; border-radius:12px; border:1px solid #233142; outline:none;
    background:#0b1118; color:var(--text); font-size:15px;
  }
  .field input:focus{border-color:#2e475e; box-shadow:0 0 0 4px var(--ring)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap)}
  .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer;
    background:linear-gradient(135deg,var(--acc) 0%, #7be6ff 100%); color:#033346;
    box-shadow:0 8px 20px rgba(90,210,255,.35); transition:transform .08s ease, filter .2s ease
  }
  button:active{transform:translateY(1px)}
  .ghost{background:#182231; color:#c6d3de; box-shadow:none}
  .note{font-size:12px;color:var(--muted)}
  .err{color:var(--err); font-size:13px}
  /* Results */
  .results-wrap{overflow:hidden; max-height:0; transition:max-height .5s ease}
  .results{padding:6px var(--pad) 18px}
  .table{
    width:100%; border-collapse:separate; border-spacing:0; overflow:auto; display:block;
    border:1px solid #1d2733; border-radius:12px; background:#0c1119;
  }
  table{width:100%; min-width:560px}
  thead th{
    position:sticky; top:0; background:#101827; z-index:1; font-size:12px; color:#a9bdcd; text-transform:uppercase; letter-spacing:.08em
  }
  th, td{padding:10px 12px; border-bottom:1px solid #172231; text-align:right}
  th:first-child, td:first-child{text-align:left}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
  .lvl{font-weight:700}
  .pill{
    display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;
    background:linear-gradient(135deg,#1c3244,#122234); color:#cfe8f7; border:1px solid #25445e
  }
  .fade-in{animation:fade .35s ease}
  @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
  footer{padding:14px var(--pad) 22px; color:#7f96a8; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>PopsCoin — калькулятор заточки</h1>
        <span class="badge">v1.1</span>
      </header>

      <div class="content">
        <div class="grid">
          <div class="field">
            <label>Тип предмета</label>
            <div class="seg" role="tablist" aria-label="Тип предмета">
              <input type="radio" name="type" id="t1" value="tool" checked>
              <label for="t1">Инструмент</label>
              <input type="radio" name="type" id="t2" value="weapon">
              <label for="t2">Оружие</label>
              <input type="radio" name="type" id="t3" value="armor">
              <label for="t3">Броня</label>
            </div>
          </div>

          <div id="inputs"></div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button id="calcBtn">Калькуляция</button>
          <button class="ghost" id="resetBtn" type="button">Сброс</button>
          <span class="note">+1 … +20 уровни будут показаны ниже.</span>
        </div>

        <div id="msg" class="err" style="margin-top:10px; display:none"></div>
      </div>

      <div class="results-wrap" id="resultsWrap">
        <div class="results">
          <div class="table fade-in" id="tableHolder" hidden></div>
        </div>
      </div>

      <footer>
        <div>Поддерживает мобильные: жест горизонтального скролла по таблице.</div>
        <div>Алгоритм соответствует текущей логике PopsCoin.</div>
      </footer>
    </div>
  </div>

<script>
(function(){
  const inputsHost = document.getElementById('inputs');
  const resultsWrap = document.getElementById('resultsWrap');
  const tableHolder = document.getElementById('tableHolder');
  const calcBtn = document.getElementById('calcBtn');
  const resetBtn = document.getElementById('resetBtn');
  const msg = document.getElementById('msg');

  const $ = (sel, root=document) => root.querySelector(sel);

  const views = {
    tool(){
      const frag = document.createElement('div');
      frag.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Мин. эффективность добычи</label>
            <input inputmode="numeric" pattern="\\d*" id="min" placeholder="например, 10">
          </div>
          <div class="field">
            <label>Макс. эффективность добычи</label>
            <input inputmode="numeric" pattern="\\d*" id="max" placeholder="например, 20">
          </div>
        </div>`;
      return frag;
    },
    weapon(){
      const frag = document.createElement('div');
      frag.innerHTML = `
        <div class="row">
          <div class="field">
            <label>Мин. урон</label>
            <input inputmode="numeric" pattern="\\d*" id="min" placeholder="например, 10">
          </div>
          <div class="field">
            <label>Макс. урон</label>
            <input inputmode="numeric" pattern="\\d*" id="max" placeholder="например, 20">
          </div>
        </div>`;
      return frag;
    },
    armor(){
      const frag = document.createElement('div');
      frag.innerHTML = `
        <div class="row3">
          <div class="field">
            <label>HP (база)</label>
            <input inputmode="numeric" pattern="\\d*" id="hp" placeholder="например, 100">
          </div>
          <div class="field">
            <label>MP (база)</label>
            <input inputmode="numeric" pattern="\\d*" id="mp" placeholder="например, 50">
          </div>
          <div class="field">
            <label>KB (база)</label>
            <input inputmode="numeric" pattern="\\d*" id="kb" placeholder="например, 5">
          </div>
        </div>`;
      return frag;
    }
  };

  function setView(kind){
    inputsHost.innerHTML = '';
    inputsHost.appendChild(views[kind]());
  }

  // initial
  setView('tool');

  document.querySelectorAll('input[name="type"]').forEach(r => {
    r.addEventListener('change', e => setView(e.target.value));
  });

  function valInt(input){
    const v = (input.value || '').toString().replace(/[^\d]/g,'');
    if(v === '') return NaN;
    return parseInt(v, 10);
  }

  function grow20Round(prev){
    // рост на 20% от предыдущего уровня с ОКРУГЛЕНИЕМ К БЛИЖАЙШЕМУ (Math.round)
    return Math.round(prev * 1.2);
  }

  function expand(){
    // анимированное раскрытие
    tableHolder.hidden = false;
    resultsWrap.style.maxHeight = resultsWrap.scrollHeight + 'px';
  }

  function collapse(){
    resultsWrap.style.maxHeight = '0px';
    tableHolder.hidden = true;
  }

  function renderTable(heads, rows){
    const th = heads.map(h => `<th>${h}</th>`).join('');
    const tr = rows.map(r => `<tr>${r.map((c,i)=>`<td${i===0?' class="lvl"':''}>${c}</td>`).join('')}</tr>`).join('');
    tableHolder.innerHTML = `<table><thead><tr>${th}</tr></thead><tbody>${tr}</tbody></table>`;
  }

  calcBtn.addEventListener('click', () => {
    msg.style.display = 'none';
    const kind = $('input[name="type"]:checked').value;

    if(kind === 'tool' || kind === 'weapon'){
      const minEl = $('#min', inputsHost), maxEl = $('#max', inputsHost);
      const baseMin = valInt(minEl), baseMax = valInt(maxEl);
      if(!Number.isFinite(baseMin) || !Number.isFinite(baseMax) || baseMin<=0 || baseMax<=0 || baseMin>baseMax){
        msg.textContent = 'Проверьте базовые значения: положительные целые, и мин ≤ макс.';
        msg.style.display = 'block'; collapse(); return;
      }
      // расчёт по уровням +1..+20 с округлением к ближайшему на каждом шаге
      let curMin = baseMin, curMax = baseMax;
      const rows = [];
      for(let lvl=1; lvl<=20; lvl++){
        curMin = grow20Round(curMin);
        curMax = grow20Round(curMax);
        const avg = Math.round((curMin + curMax) / 2);
        rows.push([`+${lvl}`, curMin, avg, curMax]);
      }
      const heads = ['Уровень', (kind==='tool'?'Мин. эфф.':'Мин. урон'),'Среднее',(kind==='tool'?'Макс. эфф.':'Макс. урон')];
      renderTable(heads, rows);
      expand();
    } else {
      // armor
      const hpEl = $('#hp', inputsHost), mpEl = $('#mp', inputsHost), kbEl = $('#kb', inputsHost);
      const baseHP = valInt(hpEl), baseMP = valInt(mpEl), baseKB = valInt(kbEl);
      if(!Number.isFinite(baseHP) || !Number.isFinite(baseMP) || !Number.isFinite(baseKB) || baseHP<=0 || baseMP<0 || baseKB<0){
        msg.textContent = 'Проверьте базовые значения брони: HP > 0, MP ≥ 0, KB ≥ 0 (целые).';
        msg.style.display = 'block'; collapse(); return;
      }
      let hp=baseHP, mp=baseMP, kb=baseKB;
      const rows = [];
      for(let lvl=1; lvl<=20; lvl++){
        hp = grow20Round(hp);
        mp = grow20Round(mp);
        kb = grow20Round(kb);
        rows.push([`+${lvl}`, hp, mp, kb]);
      }
      renderTable(['Уровень','HP','MP','KB'], rows);
      expand();
    }
  });

  resetBtn.addEventListener('click', ()=>{
    // сброс значений и результата
    const kind = $('input[name="type"]:checked').value;
    setView(kind);
    collapse();
    msg.style.display = 'none';
    // чуть-чуть «щёлк» для UX
    resetBtn.animate([{transform:'scale(1.0)'},{transform:'scale(0.97)'},{transform:'scale(1.0)'}],{duration:140});
  });

  // авто-подгон высоты при раскрытии, если меняется содержимое
  const ro = new ResizeObserver(()=>{ if(!tableHolder.hidden){ resultsWrap.style.maxHeight = resultsWrap.scrollHeight + 'px'; }});
  ro.observe(resultsWrap);
})();
</script>
</body>
</html>
